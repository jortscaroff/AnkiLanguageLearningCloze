<div id="sentence-with-input"></div>
<div id="measure"></div>
<div>{{Translation}}</div>
<button id="first-letter-hint-button">First Letter Hint</button>

<button id="hint-button">Hint</button>
<br>
<div id="hint">{{Hint}}</div>

<script>
    var measure = document.getElementById('measure');
    var clozeWord = "{{Cloze}}";
    var clozeWithBraces = "{" + clozeWord + "}";
    var sentence = "{{Sentence}}";
    var modifiedSentence = sentence.replace(clozeWithBraces, '<input type="text" id="input-box" oninput="checkInput()" onkeypress="handleEnter(event)">');

    if (modifiedSentence === sentence) {
        modifiedSentence = sentence.replace(clozeWord, '<input type="text" id="input-box" oninput="checkInput()" onkeypress="handleEnter(event)">');
    }


    // Set the text of the measure element and use its width
    measure.textContent = clozeWord;
    var inputBox = document.createElement('input');
    inputBox.type = 'text';
    inputBox.id = 'input-box';
    inputBox.oninput = checkInput;
    inputBox.style.width = (measure.offsetWidth) + 'px';
    
    document.getElementById('sentence-with-input').innerHTML = modifiedSentence;
    document.getElementById('sentence-with-input').replaceChild(inputBox, document.getElementById('input-box'));

    // Function for live feedback
    function checkInput() {
        var userInput = inputBox.value;
        if (clozeWord.startsWith(userInput)) {
						inputBox.classList.add('correct');
						inputBox.classList.remove('incorrect');
        } else {
						inputBox.classList.add('incorrect');
       			inputBox.classList.remove('correct');
        }
    }

    // Function to handle the Enter key press
    function handleEnter(e) {
        if (e.keyCode === 13) {
            e.preventDefault();
            pyLink('ans');
        }
    }

    // Function to provide a hint
    document.getElementById('hint-button').onclick = function() {
        var currentInput = inputBox.value;
        var correctLength = 0;
        for (var i = 0; i < currentInput.length && i < clozeWord.length; i++) {
            if (currentInput[i] === clozeWord[i]) {
                correctLength++;
            } else {
                break;
            }
        }
        if (correctLength < clozeWord.length) {
            inputBox.value = clozeWord.substring(0, correctLength + 1);
            checkInput(); // Check and update the color after adding the hint
        }
    }

    function getFirstJamo(syllable) {
        if (!syllable || syllable === ' ') return syllable || ''; // Handle empty/space input
        var code = syllable.charCodeAt(0) - 0xAC00;
        // Check if it's a Hangul syllable in the AC00-D7A3 range
        if (code < 0 || code > 11171) return syllable; // Return the character itself if it's not a Hangul syllable

        var initialIndex = Math.floor(code / (21 * 28));

        // Mapping from Hangul Jamo initial consonant index to Hangul Compatibility Jamo Unicode code point
        const compatibilityJamoMap = [
            0x3131, // ㄱ (from ᄀ U+1100)
            0x3132, // ㄲ (from ᄁ U+1101)
            0x3134, // ㄴ (from ᄂ U+1102)
            0x3137, // ㄷ (from ᄃ U+1103)
            0x3138, // ㄸ (from ᄄ U+1104)
            0x3139, // ㄹ (from ᄅ U+1105)
            0x3141, // ㅁ (from ᄆ U+1106)
            0x3142, // ㅂ (from ᄇ U+1107)
            0x3143, // ㅃ (from ᄈ U+1108)
            0x3145, // ㅅ (from ᄉ U+1109)
            0x3146, // ㅆ (from ᄊ U+110A)
            0x3147, // ㅇ (from ᄋ U+110B)
            0x3148, // ㅈ (from ᄌ U+110C)
            0x3149, // ㅉ (from ᄍ U+110D)
            0x314A, // ㅊ (from ᄎ U+110E)
            0x314B, // ㅋ (from ᄏ U+110F)
            0x314C, // ㅌ (from ᄐ U+1110)
            0x314D, // ㅍ (from ᄑ U+1111)
            0x314E  // ㅎ (from ᄒ U+1112)
        ];

        if (initialIndex >= 0 && initialIndex < compatibilityJamoMap.length) {
            // Return the corresponding Compatibility Jamo character
            return String.fromCharCode(compatibilityJamoMap[initialIndex]);
        } else {
            // Should not happen for valid syllables, but return original as fallback
            return syllable;
        }
    }

    document.getElementById('first-letter-hint-button').onclick = function() {
        var inputBox = document.getElementById('input-box');
        if (!inputBox) return;

        var currentInput = inputBox.value;
        // Ensure clozeWord is defined and accessible
        if (typeof clozeWord !== 'undefined' && currentInput.length < clozeWord.length) {
            var nextSyllable = clozeWord[currentInput.length];
            var firstJamo = getFirstJamo(nextSyllable); // This now returns a Compatibility Jamo

            inputBox.value += firstJamo;

            // Keep the deferred checkInput, it might still be beneficial
            setTimeout(checkInput, 0);

            // Optional: Refocus might sometimes help ensure caret position updates
            // inputBox.focus();
        }
    };

    // Set focus on the input box
    document.getElementById('input-box').focus();
</script>
